# VFScore Configuration Guide

**Purpose**: This guide explains where paths are configured and how the validation study finds your data.

---

## Fixed Issues ✅

### 1. Created `config.local.yaml`
**Location**: `VFScore/config.local.yaml` (root directory)

**What it does**: Contains your machine-specific settings, especially the `base_path` for data

### 2. Fixed `validation_study.py`
**What was wrong**: Looking for `selected_objects_optimized.csv` in `validation_study/` directory
**Fixed**: Now looks in VFScore root directory (where the file actually is)

---

## Configuration Files and Their Roles

### 1. **`config.yaml`** (Root - Shared Defaults)
**Location**: `VFScore/config.yaml`
**Purpose**: Shared configuration for all users
**Key sections**:
```yaml
data_source:
  type: legacy  # Use legacy database.csv mode
  base_path: null  # Must be set in config.local.yaml
  dataset_folder: dataset  # Relative to base_path
  database_csv: database.csv  # In VFScore root
  selected_objects_csv: selected_objects_optimized.csv  # In VFScore root
```

### 2. **`config.local.yaml`** (Root - Your Settings) ⚠️ CONFIGURE THIS
**Location**: `VFScore/config.local.yaml`
**Purpose**: YOUR machine-specific overrides
**What you need to set**:

```yaml
data_source:
  # IMPORTANT: Set this to YOUR Testing folder location
  base_path: "C:\\Users\\matti\\OneDrive - Politecnico di Bari (1)\\Dev\\Testing"
```

**How to find your base_path**:
1. Look at one of your GLB paths in `database.csv`
2. Example: `runs\2025-08-17_v1\outputs\tripo3d_v2p5_multi\353489__tripo3d_v2p5_multi_N3_A-B-C_2025-08-17_v1_ha967a257.glb`
3. Your `base_path` is the directory that contains the `runs/` folder
4. If your full path is `C:/Testing/runs/2025-08-17_v1/outputs/.../model.glb`
5. Then `base_path` should be: `C:/Testing` or `C:\\Testing`

---

## Data Files and Their Locations

### 1. **`database.csv`**
**Location**: `VFScore/database.csv` (root)
**Purpose**: Master list of all generations
**Columns**:
- `run_id`, `job_id`, `product_id`, `variant`, `algo`
- `output_glb_relpath` - **Relative to `base_path`**
- `product_name`, `manufacturer`, `category_l1`, `category_l2`, `category_l3`

**Example entry**:
```csv
2025-08-17_v1,9660a77f...,682267,,trellis_multi_stochastic,2,32.87,runs\2025-08-17_v1\outputs\trellis_multi_stochastic\682267__trellis_multi_stochastic_N2_A-B_2025-08-17_v1_h9660a77f.glb,Gabriele_user,0.02,MENTHA POP,S-CAB,Arredo,Tavoli e Sedie,Sedie
```

### 2. **`selected_objects_optimized.csv`**
**Location**: `VFScore/selected_objects_optimized.csv` (root)
**Purpose**: Subset of objects for validation study
**Columns**:
- `product_id`, `3D Object filename`, `Visual Fidelity`
- `product_name`, `manufacturer`, `category_l1`, `category_l2`, `category_l3`
- `output_glb_relpath` - **Relative to `base_path`**
- `variant`

**Example entry**:
```csv
353489,353489__rodin_multi_N3_A-B-C_2025-08-17_v1_h10f792a6.glb,0.8,LX965,LEOLUX LX,Arredo,Divani e poltrone,Poltrone,runs\2025-08-17_v1\outputs\tripo3d_v2p5_multi\353489__tripo3d_v2p5_multi_N3_A-B-C_2025-08-17_v1_ha967a257.glb,
```

---

## How Path Resolution Works

### Legacy Data Source Mode

When you run `vfscore ingest`:

1. **Reads**: `VFScore/database.csv`
2. **Filters by**: `VFScore/selected_objects_optimized.csv` (if exists)
3. **Resolves GLB paths**: `base_path` + `output_glb_relpath` from CSV
4. **Resolves reference images**: `base_path/dataset/<product_id> - <variant>/images/`

**Example**:
- `base_path` = `C:/Testing`
- `output_glb_relpath` = `runs\2025-08-17_v1\outputs\tripo3d_v2p5_multi\353489__model.glb`
- **Full GLB path** = `C:/Testing/runs/2025-08-17_v1/outputs/tripo3d_v2p5_multi/353489__model.glb`

- `product_id` = `353489`
- `variant` = `` (empty)
- **Reference images** = `C:/Testing/dataset/353489/images/*.jpg`

**With variant**:
- `product_id` = `335888`
- `variant` = `Curved backrest`
- **Reference images** = `C:/Testing/dataset/335888 - Curved backrest/images/*.jpg`

---

## Directory Structure

### Expected VFScore Structure
```
VFScore/
├── config.yaml                  # Shared config
├── config.local.yaml            # YOUR config (contains base_path)
├── database.csv                 # All generations
├── selected_objects_optimized.csv  # Validation study subset
├── validation_study/
│   └── validation_study.py     # Looks in parent dir (..) for CSVs
└── outputs/                     # Generated by pipeline
```

### Expected Testing Folder Structure
```
Testing/  ← This is your base_path
├── dataset/                     # Reference images
│   ├── 353489/
│   │   └── images/
│   │       ├── photo1.jpg
│   │       └── photo2.jpg
│   └── 335888 - Curved backrest/
│       └── images/
│           ├── photo1.jpg
│           └── photo2.jpg
└── runs/                        # Generated 3D models
    └── 2025-08-17_v1/
        └── outputs/
            ├── tripo3d_v2p5_multi/
            │   └── 353489__model.glb
            └── hunyuan3d_v2p1_single/
                └── ...
```

---

## Verification Steps

### Step 1: Verify config.local.yaml

```bash
cd VFScore
cat config.local.yaml
```

**Check**:
- ✅ `data_source.base_path` is set
- ✅ Path points to your Testing folder
- ✅ Use Windows path format: `C:\\Testing` or `C:/Testing`

### Step 2: Verify data files exist

```bash
# Check database and selected objects
ls -l database.csv selected_objects_optimized.csv

# Check one GLB path from database
# Example: Check if C:/Testing/runs/2025-08-17_v1/outputs/.../model.glb exists
```

### Step 3: Test ingestion

```bash
# Run ingest to create manifest
vfscore ingest

# Check manifest was created
cat outputs/manifest.jsonl | head -5
```

**Expected output**: Should show item records with:
- `product_id`, `variant`, `item_id`
- `ref_paths`: List of reference image paths
- `glb_path`: Full path to GLB file
- `algorithm`, `job_id`, categories, etc.

### Step 4: Run validation study

```bash
cd validation_study

# Dry run (estimate costs)
python validation_study.py

# Actual run
python validation_study.py --run --yes
```

---

## Troubleshooting

### "Ingest failed: base_path is None"
**Solution**: Set `base_path` in `config.local.yaml`

### "GLB file not found"
**Solution**:
1. Check `base_path` is correct
2. Verify GLB exists at: `base_path` + `output_glb_relpath` from CSV
3. Check path separators (Windows uses `\` or `/`)

### "Reference images not found"
**Solution**:
1. Check reference images exist at: `base_path/dataset/<product_id>/images/`
2. For variants: `base_path/dataset/<product_id> - <variant>/images/`
3. Verify `dataset_folder: dataset` in config.local.yaml

### "Objects CSV not found"
**Solution**:
- File should be in VFScore root: `VFScore/selected_objects_optimized.csv`
- **NOT** in `VFScore/validation_study/selected_objects_optimized.csv`

---

## Quick Reference: Where Everything Is

| File/Setting | Location | Purpose |
|-------------|----------|---------|
| `base_path` | `config.local.yaml` | Points to Testing folder |
| `database.csv` | VFScore root | Master list of generations |
| `selected_objects_optimized.csv` | VFScore root | Validation study subset |
| GLB files | `{base_path}/{output_glb_relpath}` | Generated 3D models |
| Reference images | `{base_path}/dataset/{product_id}/images/` | Ground truth photos |
| Reference images (variant) | `{base_path}/dataset/{product_id} - {variant}/images/` | GT photos for variants |
| Manifest | `outputs/manifest.jsonl` | Created by `vfscore ingest` |

---

## Next Steps

1. **Verify** `config.local.yaml` has correct `base_path`
2. **Test** with `vfscore ingest` to create manifest
3. **Run** validation study: `cd validation_study && python validation_study.py`

If you still have issues, check:
- Does your Testing folder have `dataset/` and `runs/` subdirectories?
- Do the paths in database.csv match your actual file locations?
- Are reference images in the right folders?
